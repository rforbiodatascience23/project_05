---
title: "Read_count_analysis"
format: html
editor: visual
---

```{r}
library(tidyverse)
```

```{r}
raw_data <- read_tsv(gzfile('../data/meta_gene_table.tsv.gz'))
```

## Count for each sample

**Missing make levels**

```{r}
gene_cols <- 
  raw_data |> 
  dplyr::select(starts_with('ENSG')) |> 
  colnames()
  

Sample_count <- 
  raw_data |> 
  pivot_longer(gene_cols, 
               names_to = 'Gene', 
               values_to = 'Expression') |> 
  group_by(Sample) |> 
  summarise(Read_count = sum(Expression)) |> 
  mutate(Sample = factor(Sample, 
                         levels = c("1L", "1N",
                                    "2L", "2N",
                                    "3L", "3N",
                                    "4L", "4N",
                                    "5L", "5N",
                                    "6L", "6N",
                                    "7L", "7N",
                                    "8L", "8N",
                                    "9L", "9N",
                                    "10L", "10N", 
                                    "11L", "11N", 
                                    "12L", "12N", 
                                    "13L", "13N", 
                                    "14L", "14N",
                                    "15L", "15N",
                                    "16L", "16N",
                                    "17L", "17N",
                                    "18L", "18N",
                                    "19L", "19N",
                                    "20L", "20N",
                                    "21L", "21N",
                                    "22L", "22N")
         ))


Sample_count |> 
  ggplot(aes(x = fct_rev(Sample), y = Read_count, fill = Sample)) +
  geom_bar(stat = 'identity') +
  coord_flip() +
  labs(title = 'Number of Reads in Each Sample',
       x = 'Sample',
       y = 'Number of reads') +
  theme_minimal() +
  theme(plot.title = element_text(vjust = 2,
                                  hjust = 0.5,
                                  face = 'bold'),
        panel.border = element_rect(colour = "black", 
                                    fill = 'transparent',
                                    size = 0.5),
        legend.position = 'none')
```

```{r}
genes_sig <- high_diff_lose |> 
  select(gene) |> 
  unique()

sig <- gene_expr_diff |> 
  group_by(gene) |> 
  filter(any(expr_diff >= 3) | any(expr_diff <= 1/3))

sig_processed <- sig |> 
  group_by(Sample) |> 
  summarise(read_count_sig_Lesion = sum(Lesion),
            read_count_sig_Perilesion = sum(Perilesion)) |> 
  pivot_longer((starts_with("read")),
               names_to = "read_count",
               values_to = "count") |> 
  arrange(Sample)

sig_processed <- sig_processed |> 
  mutate(Sample = as.numeric(Sample))

#The factorization doesnt work here
sig_processed |>
  arrange(Sample) |> 
  group_by(Sample) |> S
  mutate(Sample = factor(Sample, 
                         levels = c("1L", "1N",
                                    "2L", "2N",
                                    "3L", "3N",
                                    "4L", "4N",
                                    "5L", "5N",
                                    "6L", "6N",
                                    "7L", "7N",
                                    "8L", "8N",
                                    "9L", "9N",
                                    "10L", "10N", 
                                    "11L", "11N", 
                                    "12L", "12N", 
                                    "13L", "13N", 
                                    "14L", "14N",
                                    "15L", "15N",
                                    "16L", "16N",
                                    "17L", "17N",
                                    "18L", "18N",
                                    "19L", "19N",
                                    "20L", "20N",
                                    "21L", "21N",
                                    "22L", "22N")))

#Plot will work if the Sample variable is factorized
  sig_processed |>
  arrange(Sample) |> 
  ggplot(aes(x = fct_rev(Sample), y = count, fill = Sample)) +
  geom_bar(stat = 'identity') +
  coord_flip() +
  labs(title = 'Number of Reads in Each Sample',
       x = 'Sample',
       y = 'Number of reads') +
  theme_minimal() +
  theme(plot.title = element_text(vjust = 2,
                                  hjust = 0.5,
                                  face = 'bold'),
        panel.border = element_rect(colour = "black", 
                                    fill = 'transparent',
                                    size = 0.5),
        legend.position = 'none')
```
